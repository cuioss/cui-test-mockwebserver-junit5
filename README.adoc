= cui-test-mockwebserver-junit5

== Status

image:https://github.com/cuioss/cui-test-mockwebserver-junit5/actions/workflows/maven.yml/badge.svg[Java CI with Maven,link=https://github.com/cuioss/cui-test-mockwebserver-junit5/actions/workflows/maven.yml]
image:http://img.shields.io/:license-apache-blue.svg[License,link=http://www.apache.org/licenses/LICENSE-2.0.html]
image:https://maven-badges.herokuapp.com/maven-central/de.cuioss.test/cui-test-mockwebserver-junit5/badge.svg[Maven Central,link=https://maven-badges.herokuapp.com/maven-central/de.cuioss.test/cui-test-mockwebserver-junit5]

https://sonarcloud.io/summary/new_code?id=cuioss_cui-test-mockwebserver-junit5[image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_cui-test-mockwebserver-junit5&metric=alert_status[Quality
Gate Status]]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_cui-test-mockwebserver-junit5&metric=ncloc[Lines of Code,link=https://sonarcloud.io/summary/new_code?id=cuioss_cui-test-mockwebserver-junit5]
image:https://sonarcloud.io/api/project_badges/measure?project=cuioss_cui-test-mockwebserver-junit5&metric=coverage[Coverage,link=https://sonarcloud.io/summary/new_code?id=cuioss_cui-test-mockwebserver-junit5]


https://cuioss.github.io/cui-test-mockwebserver-junit5/about.html[Generated Documentation on github-pages]

== What is it?

A junit 5 extension for link:https://github.com/square/okhttp/tree/master/mockwebserver[MockWebServer]
 providing some convenience,
compared to the original.

=== Maven Coordinates

[source,xml]
----
    <dependency>
        <groupId>de.cuioss.test</groupId>
        <artifactId>cui-test-mockwebserver-junit5</artifactId>
    </dependency>
----

== Using MockWebServer

=== Basic usage with Parameter Injection

The recommended approach is to use parameter injection rather than implementing the MockWebServerHolder interface:

[source,java]
----
include::src/test/java/de/cuioss/test/mockwebserver/ParameterResolverTest.java[tags=parameter-resolver-example]
----

=== Dispatching Requests

The recommended approach is to set up the dispatcher directly in your test method:

[source,java]
----
include::src/test/java/de/cuioss/test/mockwebserver/dispatcher/EndpointDispatcherExampleTest.java[tags=dispatcher-example]
----

=== ModuleDispatcherElement

`ModuleDispatcherElement` enables reusable request handling in `EnableMockWebServer` contexts. It returns an `Optional<MockResponse>` for matching requests.

Example JWKS endpoint dispatcher:

[source,java]
----
/**
 * Handles JWKS file resolution from the mock OAuth server, serving
 * "src/test/resources/token/test-public-key.jwks"
 */
public class JwksResolveDispatcher implements ModuleDispatcherElement {

    /** "/oidc/jwks.json" */
    public static final String LOCAL_PATH = "/oidc/jwks.json";

    @Getter
    @Setter
    private int callCounter = 0;

    @Override
    public Optional<MockResponse> handleGet(@NonNull RecordedRequest request) {
        callCounter++;
        return Optional.of(new MockResponse().addHeader("Content-Type", "application/json")
                .setBody(FileLoaderUtility
                        .toStringUnchecked(FileLoaderUtility.getLoaderForPath(PUBLIC_KEY_JWKS)))
                .setResponseCode(SC_OK));
    }

    @Override
    public String getBaseUrl() {
        return LOCAL_PATH;
    }

    /**
     * Verifies request count
     *
     * @param expected Expected number of requests
     */
    public void assertCallsAnswered(int expected) {
        assertEquals(expected, callCounter);
    }
}
----

Implementation example:

[source,java]
----
@EnableAutoWeld
@EnablePortalConfiguration
@EnableMockWebServer
class TokenParserProducerTest implements ShouldBeNotNull<TokenParserProducer>, MockWebServerHolder {

    @Setter
    private MockWebServer mockWebServer;

    protected int mockserverPort;

    private final JwksResolveDispatcher jwksResolveDispatcher = new JwksResolveDispatcher();

    @Getter
    private final CombinedDispatcher dispatcher = new CombinedDispatcher().addDispatcher(jwksResolveDispatcher);

    @BeforeEach
    void setupMockServer() {
        mockserverPort = mockWebServer.getPort();
        configuration.put(VERIFY_SIGNATURE_JWKS_URL,
                "http://localhost:" + mockserverPort + jwksResolveDispatcher.getBaseUrl());
        configuration.update(VERIFY_SIGNATURE_ISSUER, TestTokenProducer.ISSUER);
        configuration.update(VERIFY_SIGNATURE_REFRESH_INTERVAL, "60");
        jwksResolveDispatcher.setCallCounter(0);
    }

    @Test
    void shouldCacheMultipleCalls() {
        jwksResolveDispatcher.assertCallsAnswered(0);
        String token = validSignedJWTWithClaims(PATIENT_ACCESS_TOKEN);
        JWTParser parser = parserProvider.get();

        for (int i = 0; i < 100; i++) {
            JsonWebToken jsonWebToken = assertDoesNotThrow(() -> ParsedToken.jsonWebTokenFrom(token, parser, LOGGER));
            assertValidJsonWebToken(jsonWebToken, token);
        }
        // Note: Initial implementation results in 2 calls instead of 1
        assertTrue(jwksResolveDispatcher.getCallCounter() < 3);

        for (int i = 0; i < 100; i++) {
            JsonWebToken jsonWebToken = assertDoesNotThrow(() -> ParsedToken.jsonWebTokenFrom(token, parser, LOGGER));
            assertValidJsonWebToken(jsonWebToken, token);
        }
        assertTrue(jwksResolveDispatcher.getCallCounter() < 3);
    }
}
----

=== Manual Server Start

The extension supports manual server start with the `manualStart = true` option. This is useful when you need more control over when and how the server is started:

[source,java]
----
include::src/test/java/de/cuioss/test/mockwebserver/MockWebServerManualStartTest.java[tags=manual-start-test]
----

==== Important URIBuilder Precautions with Manual Start

When using `manualStart = true`, you need to be careful with the injected `URIBuilder` parameter:

* Before the server is started, the injected `URIBuilder` is a placeholder that cannot be used to build URIs
* If you try to build a URI from this placeholder, it will throw an `IllegalStateException`
* You must create a proper `URIBuilder` *after* manually starting the server

[source,java]
----
// INCORRECT - Will throw IllegalStateException if server not started
URI uri = uriBuilder.addPathSegment("api").build();

// CORRECT - Create a proper URIBuilder after starting the server
server.start();
URIBuilder properUriBuilder = URIBuilder.from(server.url("/").url());
URI uri = properUriBuilder.addPathSegment("api").build();

----

=== URIBuilder Usage

When building URIs with multiple path segments,
prefer using the `addPathSegments` method instead of chaining multiple `addPathSegment` calls:

[source,java]
----
// RECOMMENDED - Use addPathSegments for multiple path segments
URI uri = uriBuilder.addPathSegments("api", "users", "123").build();

URI uri = uriBuilder.addPathSegment("api").addPathSegment("users").addPathSegment("123").build();
----

=== Parameter Injection

MockWebServerExtension implements ParameterResolver, allowing direct injection of MockWebServer and related parameters into test methods. This is the recommended approach for accessing the server and related components.

See the examples above for how to use parameter injection in your tests.

Supported parameter types:

* `MockWebServer` - The server instance
* `URIBuilder` - A builder for constructing request URIs
* `SSLContext` - The SSL context for HTTPS connections (when HTTPS is enabled)

=== HTTPS Support

When HTTPS is enabled, the extension automatically makes the SSLContext available for parameter injection, simplifying HTTPS testing:

[source,java]
----
include::src/test/java/de/cuioss/test/mockwebserver/https/ExtensionProvidedHttpsTest.java[tags=https-example]
----

HTTPS configuration options:

* `useHttps` - Enable HTTPS support (default: false)
* `keyMaterialProviderIsSelfSigned` - Use auto-generated self-signed certificates (default: false)
* `keyMaterialProviderIsTestClass` - Use custom certificates provided by the test class (default: false)
